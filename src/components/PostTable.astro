---
import type { CollectionEntry } from 'astro:content';
import { calculateReadingTime } from '../utils/readingTime';

export interface Props {
  posts: CollectionEntry<'blog'>[];
  lang: 'es' | 'en';
}

const { posts, lang } = Astro.props;

function groupPostsByYear(posts: CollectionEntry<'blog'>[]) {
  return posts.reduce(
    (acc, post) => {
      const year = new Date(post.data.pubDate).getFullYear();
      if (!acc[year]) acc[year] = [];
      acc[year].push(post);
      return acc;
    },
    {} as Record<number, CollectionEntry<'blog'>[]>
  );
}

const groupedPosts = groupPostsByYear(
  posts.filter((post) => !post.data.draft).filter((post) => post.data.lang === lang)
);
---

<section class="timeline">
  {
    Object.entries(groupedPosts)
      .sort((a, b) => Number(b[0]) - Number(a[0]))
      .map(([year, posts]) => (
        <div class="year-group">
          <div class="year-marker">
            <span class="dot" />
            <span class="year">{year}</span>
          </div>
          <div class="posts-list">
            {posts.map((post) => {
              const readingTime = calculateReadingTime(post.body ?? '');
              return (
                <a href={`/${lang}/blog/${post.id}`} class="post-item">
                  <span class="post-title">{post.data.title}</span>
                  <span class="post-description">{post.data.description}</span>
                  <span class="post-time">â˜• {readingTime} min read</span>
                </a>
              );
            })}
          </div>
        </div>
      ))
  }
</section>

<style>
  .timeline {
    position: relative;
    padding-left: 24px;
  }

  .timeline::before {
    content: '';
    position: absolute;
    left: 5px;
    top: 12px;
    bottom: 0;
    width: 1px;
    background: var(--border-color);
  }

  .year-group {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .year-group:last-child {
    margin-bottom: 0;
  }

  .year-marker {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .dot {
    position: absolute;
    left: -24px;
    width: 11px;
    height: 11px;
    background: var(--background);
    border: 2px solid var(--border-color);
    border-radius: 50%;
  }

  .year {
    font-size: 1.1em;
    font-weight: 600;
    color: var(--font-color-highlight);
  }

  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .post-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.75rem;
    margin-left: -0.75rem;
    border-radius: 8px;
    text-decoration: none;
    color: inherit;
    transition: background 0.15s ease;
  }

  .post-item:hover {
    background: var(--background-hover);
  }

  .post-title {
    color: var(--font-color-highlight);
    font-weight: 500;
  }

  .post-description {
    font-size: 0.85em;
    color: var(--font-color-normal);
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
  }

  .post-time {
    font-size: 0.75em;
    color: var(--font-color-normal);
    opacity: 0.7;
  }

  @media (max-width: 560px) {
    .timeline {
      padding-left: 20px;
    }

    .dot {
      left: -20px;
      width: 9px;
      height: 9px;
    }

    .timeline::before {
      left: 4px;
    }

    .post-description {
      -webkit-line-clamp: 1;
    }
  }
</style>
